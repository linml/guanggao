function registerHandler(e,r){var o=handlers[r];e.on(r,function(s){("login"==r||e.userId)&&fibers(function(){o(e,s)}).run()})}var fibers=require("fibers"),crypto=require("../utils/crypto"),tokenMgr=require("./tokenmgr"),roomMgr=require("./roommgr"),userMgr=require("./usermgr"),http=require("../utils/http"),db=require("../utils/dbsync"),express=require("express"),app=express();app.all("*",function(e,r,o){r.header("Access-Control-Allow-Origin","*"),r.header("Access-Control-Allow-Headers","X-Requested-With"),r.header("Access-Control-Allow-Methods","PUT,POST,GET,DELETE,OPTIONS"),r.header("X-Powered-By"," 3.2.1"),r.header("Content-Type","application/json;charset=utf-8"),http.send(r,0,"ok",{isonline:!0})});var io=null,config=null,handlers={};handlers.login=function(e,r){if(r=JSON.parse(r),null==e.userId){var o=r.token,s=r.roomid,n=r.time,i=r.sign;if(null!=o&&null!=s&&null!=i&&null!=n)if(crypto.md5(s+o+n+config.ROOM_PRI_KEY)==i)if(0!=tokenMgr.isTokenValid(o)){var t=tokenMgr.getUserID(o),s=roomMgr.getUserRoom(t);userMgr.bind(t,e),e.userId=t;var u=roomMgr.getRoom(s),a=roomMgr.getUserSeat(t);u.seats[a].ip=e.handshake.address;for(var l=null,d=[],g=0;g<u.seats.length;++g){var c=u.seats[g],m=!1;c.userId>0&&(m=userMgr.isOnline(c.userId)),d.push({userid:c.userId,ip:c.ip,score:c.score,name:c.name,online:m,ready:c.ready,seatindex:g}),t==c.userId&&(l=d[g])}var f=db.get_configs(),_={errcode:0,errmsg:"ok",data:{roomid:u.id,conf:u.conf,numofgames:u.numOfGames,seats:d,inter_emoji_conf:{inter_cost_type:f?f.interactive_emoji_cost_type:1,inter_cost_num:f?f.interactive_emoji_cost_num:0}}};if(e.emit("login_result",_),userMgr.broacastInRoom("new_user_comes_push",l,t),e.roomInfo=u,e.gameMgr=u.gameMgr,roomMgr.setReady(t),e.emit("login_finished"),null!=u.dr){var h=u.dr,r={time:(h.endTime-Date.now())/1e3,states:h.states};userMgr.sendMsg(t,"dissolve_notice_push",r)}roomMgr.computeOnlineCnt(u)}else e.emit("login_result",{errcode:3,errmsg:"token out of time."});else e.emit("login_result",{errcode:2,errmsg:"login failed. invalid sign!"});else e.emit("login_result",{errcode:1,errmsg:"invalid parameters"})}},handlers.ready=function(e,r){var o=e.userId;null!=o&&(roomMgr.setReady(o),userMgr.broacastInRoom("user_ready_push",{userid:o,ready:!0},o,!0))},handlers.huanpai=function(e,r){if(null!=e.userId&&null!=r){"string"==typeof r&&(r=JSON.parse(r));var o=r.p1,s=r.p2,n=r.p3;null!=o&&null!=s&&null!=n?e.gameMgr.huanSanZhang(e.userId,o,s,n):console.log("invalid data")}},handlers.dingque=function(e,r){if(null!=e.userId){var o=r;e.gameMgr.dingQue(e.userId,o)}},handlers.chupai=function(e,r){if(null!=e.userId){var o=r;e.gameMgr.chuPai(e.userId,o)}},handlers.chi=function(e,r){null!=e.userId&&e.gameMgr.chi(e.userId,r)},handlers.peng=function(e,r){null!=e.userId&&e.gameMgr.peng(e.userId)},handlers.gang=function(e,r){if(null!=e.userId&&null!=r){var o=-1;if("number"==typeof r)o=r;else{if("string"!=typeof r)return void console.log("gang:invalid param");o=parseInt(r)}e.gameMgr.gang(e.userId,o)}},handlers.hu=function(e,r){null!=e.userId&&e.gameMgr.hu(e.userId)},handlers.guo=function(e,r){null!=e.userId&&e.gameMgr.guo(e.userId)},handlers.chat=function(e,r){if(null!=e.userId){var o=r;userMgr.broacastInRoom("chat_push",{sender:e.userId,content:o},e.userId,!0)}},handlers.quick_chat=function(e,r){if(null!=e.userId){var o=r;userMgr.broacastInRoom("quick_chat_push",{sender:e.userId,content:o},e.userId,!0)}},handlers.voice_msg=function(e,r){null!=e.userId&&userMgr.broacastInRoom("voice_msg_push",{sender:e.userId,content:r},e.userId,!0)},handlers.emoji=function(e,r){if(null!=e.userId){var o=r;userMgr.broacastInRoom("emoji_push",{sender:e.userId,content:o},e.userId,!0)}},handlers.interactive_emoji=function(e,r){var o=e.userId;if(null!=o){var s=1,n=500,i=db.get_configs();null!=i?(s=i.interactive_emoji_cost_type,n=i.interactive_emoji_cost_num):console.log("[Error] - can't get config data");var t=0,u=null;1==s?(t=db.get_user_coins(o),u=db.cost_coins):2==s&&(t=db.get_user_gems(o),u=db.cost_gems),null!=t&&null!=u?t<n?userMgr.sendMsg(o,"interactive_emoji_push",{errcode:2,cash_type:s}):u(o,n,"- send interactive emoji")?userMgr.broacastInRoom("interactive_emoji_push",{errcode:0,sender:o,content:r},o,!0):userMgr.sendMsg(o,"interactive_emoji_push",{errcode:3,cash_type:s}):userMgr.sendMsg(o,"interactive_emoji_push",{errcode:1,cash_type:s})}},handlers.exit=function(e,r){var o=e.userId;if(null!=o){var s=roomMgr.getUserRoom(o);null!=s&&(roomMgr.hasBegan(s)||roomMgr.isCreator(o)||(userMgr.broacastInRoom("exit_notify_push",o,o,!1),roomMgr.exitRoom(o),userMgr.del(o),e.emit("exit_result"),e.userId=null,e.disconnect()))}},handlers.baoting=function(e,r){var o=e.userId;null!=o&&e.gameMgr.baoTing(o,r)},handlers.dispress=function(e,r){var o=e.userId;if(null!=o){var s=roomMgr.getUserRoom(o);null!=s&&(roomMgr.hasBegan(s)||0!=roomMgr.isCreator(s,o)&&(userMgr.broacastInRoom("dispress_push",{},o,!0),roomMgr.onRoomEnd(roomMgr.getRoom(s),!0),userMgr.kickAllInRoom(s),roomMgr.destroy(s),e.userId=null,e.disconnect()))}},handlers.dissolve_request=function(e,r){var o=e.userId;if(null!=o){var s=roomMgr.getUserRoom(o);if(null!=s&&0!=roomMgr.hasBegan(s)){var n=roomMgr.dissolveRequest(s,o);if(null!=n){var i=n.dr,r={time:(i.endTime-Date.now())/1e3,states:i.states};userMgr.broacastInRoom("dissolve_notice_push",r,o,!0)}}}},handlers.dissolve_agree=function(e,r){var o=e.userId;if(null!=o){var s=roomMgr.getUserRoom(o);if(null!=s){var n=roomMgr.dissolveAgree(s,o,!0);if(null!=n){var i=n.dr,r={time:(i.endTime-Date.now())/1e3,states:i.states};userMgr.broacastInRoom("dissolve_notice_push",r,o,!0);for(var t=!0,u=0;u<i.states.length;++u)if(0==i.states[u]){t=!1;break}t&&roomMgr.doDissolve(s)}}}},handlers.dissolve_reject=function(e,r){var o=e.userId;if(null!=o){var s=roomMgr.getUserRoom(o);null!=s&&null!=roomMgr.dissolveAgree(s,o,!1)&&userMgr.broacastInRoom("dissolve_cancel_push",{},o,!0)}},handlers.disconnect=function(e,r){var o=e.userId;if(o){var r={userid:o,online:!1};if(userMgr.get(o)==e){userMgr.broacastInRoom("user_state_push",r,o),userMgr.del(o),e.userId=null;var s=roomMgr.getUserRoom(o),n=roomMgr.getRoom(s);if(n){var i=roomMgr.getUserSeat(o);i>=0&&(n.seats[i].ip=null),roomMgr.computeOnlineCnt(n)}}}},handlers.game_ping=function(e,r){e.userId&&e.emit("game_pong")},handlers.forceBegin_req=function(e,r){var o=e.userId;null!=o&&roomMgr.forceBegin(o)&&userMgr.broacastInRoom("user_forcebegin_push",{userid:o,ready:!0},o,!0)},handlers.to_readying=function(e,r){var o=e.userId;null!=o&&roomMgr.to_readying(o,r)},exports.start=function(e){config=e;var r=require("http").createServer(app);io=require("socket.io")(r),r.listen(config.CLIENT_PORT),io.sockets.on("connection",function(e){for(var r in handlers)registerHandler(e,r)}),console.log("socket service is listening on "+config.CLIENT_PORT)};